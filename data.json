import streamlit as st
import pandas as pd
from datetime import date, timedelta

# Configuraci√≥n de la p√°gina
st.set_page_config(
    page_title="Gesti√≥n de Ventas Streaming",
    page_icon="üì∫",
    layout="wide"
)

# --- FUNCIONES DE GESTI√ìN DE DATOS ---

def cargar_datos():
    """Carga los datos del archivo CSV o crea uno nuevo si no existe."""
    try:
        df = pd.read_csv("ventas_streaming.csv")
        # Convertir fechas a formato datetime
        df['fecha_venta'] = pd.to_datetime(df['fecha_venta'])
        df['vencimiento'] = pd.to_datetime(df['vencimiento'])
        return df
    except FileNotFoundError:
        # Estructura inicial si no hay archivo
        columnas = [
            "id", "fecha_venta", "cliente", "servicio", 
            "precio", "metodo_pago", "vencimiento", "estado"
        ]
        return pd.DataFrame(columns=columnas)

def guardar_datos(df):
    """Guarda el DataFrame en un archivo CSV."""
    df.to_csv("ventas_streaming.csv", index=False)

def generar_id(df):
    """Genera un ID √∫nico basado en el √≠ndice."""
    if df.empty:
        return 1
    else:
        return df['id'].max() + 1

# --- INTERFAZ DE USUARIO ---

st.title("üì∫ Dashboard de Ventas de Pantallas y Streaming")

# Cargar datos
df = cargar_datos()

# --- BARRA LATERAL (AGREGAR / EDITAR) ---
with st.sidebar:
    st.header("üìù Registrar Venta")
    st.markdown("Completa los datos para agregar o actualizar una venta.")
    
    # Detectar si estamos editando
    editar_fila = st.session_state.get('editar_fila', None)

    with st.form("form_venta", clear_on_submit=True):
        # Campos del formulario
        input_fecha = st.date_input("Fecha de Venta", value=date.today())
        input_cliente = st.text_input("Cliente (Nombre/Correo)", value=editar_fila['cliente'] if editar_fila else "")
        input_servicio = st.selectbox("Servicio", ["Netflix", "Disney+", "HBO Max", "Amazon Prime", "Spotify", "Otro"], index=0 if not editar_fila else ["Netflix", "Disney+", "HBO Max", "Amazon Prime", "Spotify", "Otro"].index(editar_fila.get('servicio', 'Netflix')))
        input_precio = st.number_input("Precio ($)", min_value=0.0, step=0.5, value=editar_fila['precio'] if editar_fila else 0.0)
        input_metodo = st.selectbox("M√©todo de Pago", ["Transferencia", "Efectivo", "PayPal", "Cripto", "Otro"], index=0 if not editar_fila else ["Transferencia", "Efectivo", "PayPal", "Cripto", "Otro"].index(editar_fila.get('metodo_pago', 'Transferencia')))
        input_vencimiento = st.date_input("Fecha de Vencimiento", value=date.today() + timedelta(days=30))
        input_estado = st.selectbox("Estado", ["Pagado", "Pendiente", "Vencido"], index=0 if not editar_fila else ["Pagado", "Pendiente", "Vencido"].index(editar_fila.get('estado', 'Pagado')))
        
        enviar = st.form_submit_button("Guardar Venta")
        
        if enviar:
            if editar_fila:
                # Modo Edici√≥n
                idx = df[df['id'] == editar_fila['id']].index[0]
                df.at[idx, 'fecha_venta'] = input_fecha
                df.at[idx, 'cliente'] = input_cliente
                df.at[idx, 'servicio'] = input_servicio
                df.at[idx, 'precio'] = input_precio
                df.at[idx, 'metodo_pago'] = input_metodo
                df.at[idx, 'vencimiento'] = input_vencimiento
                df.at[idx, 'estado'] = input_estado
                st.success("‚úÖ Venta actualizada correctamente!")
                st.session_state['editar_fila'] = None # Limpiar estado de edici√≥n
            else:
                # Modo Agregar
                nuevo_id = generar_id(df)
                nuevo_registro = {
                    "id": nuevo_id,
                    "fecha_venta": input_fecha,
                    "cliente": input_cliente,
                    "servicio": input_servicio,
                    "precio": input_precio,
                    "metodo_pago": input_metodo,
                    "vencimiento": input_vencimiento,
                    "estado": input_estado
                }
                df_nuevo = pd.DataFrame([nuevo_registro])
                df = pd.concat([df, df_nuevo], ignore_index=True)
                st.success("‚úÖ Venta registrada correctamente!")
            
            guardar_datos(df)
            st.rerun()

# --- √ÅREA PRINCIPAL (TABLA Y M√âTRICAS) ---

# M√©tricas r√°pidas
col1, col2, col3 = st.columns(3)
with col1:
    total_ventas = df['precio'].sum()
    st.metric("üí∞ Ingresos Totales", f"${total_ventas:.2f}")
with col2:
    ventas_mes = df[df['fecha_venta'].dt.month == date.today().month]['precio'].sum()
    st.metric("üìÖ Ventas este Mes", f"${ventas_mes:.2f}")
with col3:
    cuentas_vencidas = df[df['estado'] == 'Vencido'].shape[0]
    st.metric("‚ö†Ô∏è Cuentas Vencidas", cuentas_vencidas)

st.divider()

# Buscador y Filtros
st.subheader("üìã Listado de Ventas")
filtro_texto = st.text_input("üîç Buscar por cliente o servicio...", "")
df_filtrado = df.copy()

if filtro_texto:
    mask = df_filtrado['cliente'].str.contains(filtro_texto, case=False) | df_filtrado['servicio'].str.contains(filtro_texto, case=False)
    df_filtrado = df_filtrado[mask]

# Formato de la tabla para mostrar
columnas_a_mostrar = ["id", "fecha_venta", "cliente", "servicio", "precio", "metodo_pago", "vencimiento", "estado"]

# Mostrar la tabla
if not df_filtrado.empty:
    for index, row in df_filtrado.iterrows():
        with st.container():
            cols = st.columns([0.5, 1, 2, 1.5, 1, 1.5, 1.5, 1, 0.5, 0.5])
            cols[0].write(f"**{row['id']}**")
            cols[1].write(row['fecha_venta'].strftime("%d/%m/%Y"))
            cols[2].write(row['cliente'])
            
            # Etiqueta de color para el servicio
            cols[3].markdown(f"<span style='background-color:#E0E0E0; padding:4px; border-radius:4px; font-size:12px;'>{row['servicio']}</span>", unsafe_allow_html=True)
            
            cols[4].write(f"${row['precio']:.2f}")
            cols[5].write(row['metodo_pago'])
            cols[6].write(row['vencimiento'].strftime("%d/%m/%Y"))
            
            # Etiqueta de color para el estado
            color_estado = "#FFCCCC" if row['estado'] == 'Vencido' else "#CCFFCC" if row['estado'] == 'Pagado' else "#FFFFCC"
            cols[7].markdown(f"<span style='background-color:{color_estado}; padding:4px; border-radius:4px; font-size:12px;'>{row['estado']}</span>", unsafe_allow_html=True)
            
            # Bot√≥n Editar
            if cols[8].button("‚úèÔ∏è", key=f"edit_{row['id']}"):
                st.session_state['editar_fila'] = row.to_dict()
                st.rerun()
            
            # Bot√≥n Eliminar
            if cols[9].button("üóëÔ∏è", key=f"del_{row['id']}"):
                df.drop(index, inplace=True)
                guardar_datos(df)
                st.rerun()
else:
    st.info("No hay ventas registradas que coincidan con la b√∫squeda.")
